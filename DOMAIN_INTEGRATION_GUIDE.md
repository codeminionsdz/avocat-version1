# Domain Integration Guide ‚Äì avocat-dz.online

## Overview
This guide documents the complete integration of the production domain `https://avocat-dz.online` into the Avoca platform. All configuration, code changes, and deployment steps are outlined below.

---

## ‚úÖ Code Changes Completed

### 1. Centralized Configuration (`lib/config.ts`) ‚úÖ
Created a single source of truth for all URLs:

```typescript
// Priority-based URL resolution:
// 1. NEXT_PUBLIC_SITE_URL (env var)
// 2. window.location.origin (client fallback)
// 3. localhost:3000 (dev default)

export function getBaseUrl(): string
export function getUrl(path: string): string
export function getLawyerProfileUrl(lawyerId: string): string
export function getInsightUrl(insightId: string): string
```

**Benefits:**
- Environment-aware (dev/staging/prod)
- No hardcoded domains
- Type-safe with TypeScript
- Works on both server and client

### 2. QR Code Generation ‚úÖ
**Updated Files:**
- `app/lawyer/[id]/page.tsx` - Public profile QR codes
- `app/lawyer/profile/edit/page.tsx` - Edit profile QR codes

**Changes:**
- Replaced `window.location.origin` with `getLawyerProfileUrl()`
- QR codes now generate with production domain: `https://avocat-dz.online/lawyer/[id]`

### 3. Share Utilities ‚úÖ
**Updated File:** `lib/share-utils.ts`

**Changes:**
- Replaced `window.location.origin` with `getBaseUrl()`
- Legal Insights sharing now uses production URLs
- Share text includes: `https://avocat-dz.online/insights/[id]`

### 4. Auth Redirects ‚úÖ
**Updated File:** `app/auth/register/page.tsx`

**Changes:**
- Replaced `window.location.origin` with `getBaseUrl()`
- Removed `NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL` (obsolete)
- Auth redirects now use `NEXT_PUBLIC_SITE_URL` environment variable

**Flow:**
1. User registers ‚Üí Email sent with confirmation link
2. Confirmation link points to: `https://avocat-dz.online/...`
3. After confirmation, user redirected correctly

### 5. Metadata & SEO ‚úÖ
**Updated File:** `app/layout.tsx`

**Added:**
```typescript
export const metadata: Metadata = {
  title: {
    default: "Avoca ‚Äì Legal Services in Algeria",
    template: "%s | Avoca",
  },
  metadataBase: new URL("https://avocat-dz.online"),
  openGraph: {
    url: "https://avocat-dz.online",
    siteName: "Avoca",
    // ...full OpenGraph config
  },
  keywords: ["lawyer", "avocat", "ŸÖÿ≠ÿßŸÖŸä", "Algeria", ...],
}
```

**Benefits:**
- Proper canonical URLs
- OpenGraph tags for social sharing
- Twitter/Facebook preview cards
- SEO-optimized

---

## üîß Environment Variables

### Required Setup

Create/update `.env.local` (development):
```env
NEXT_PUBLIC_SITE_URL=http://localhost:3000
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

Production environment (Vercel/hosting platform):
```env
NEXT_PUBLIC_SITE_URL=https://avocat-dz.online
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

**üìÑ Reference:** See `.env.example` for complete documentation

---

## üìß Supabase Dashboard Configuration

### CRITICAL: Update These Settings in Supabase

Login to: [https://supabase.com/dashboard](https://supabase.com/dashboard)

Navigate to your project: `ozqoeqpfkeafqvwjswll`

### 1. Authentication Settings
**Path:** Authentication ‚Üí URL Configuration

| Setting | Value |
|---------|-------|
| **Site URL** | `https://avocat-dz.online` |
| **Redirect URLs** | Add the following: |
| | `https://avocat-dz.online/**` |
| | `https://avocat-dz.online/client/onboarding` |
| | `https://avocat-dz.online/lawyer/**` |
| | `http://localhost:3000/**` (keep for dev) |

**Why:** Supabase validates redirects against this whitelist. Without it, email confirmations fail.

### 2. Email Templates
**Path:** Authentication ‚Üí Email Templates

Update all email templates to use production domain:

#### Confirm Signup Template
```html
<h2>Confirm your signup</h2>
<p>Follow this link to confirm your account:</p>
<p><a href="{{ .ConfirmationURL }}">Confirm your email</a></p>
<p>This link expires in 24 hours.</p>
<p>Best regards,<br>The Avoca Team</p>
<p><small>Avoca ‚Äì Legal Services in Algeria<br>https://avocat-dz.online</small></p>
```

#### Reset Password Template
```html
<h2>Reset your password</h2>
<p>Follow this link to reset your password:</p>
<p><a href="{{ .ConfirmationURL }}">Reset password</a></p>
<p>This link expires in 1 hour.</p>
<p>If you didn't request this, please ignore this email.</p>
<p>Best regards,<br>The Avoca Team</p>
<p><small>Avoca ‚Äì Legal Services in Algeria<br>https://avocat-dz.online</small></p>
```

**Note:** `{{ .ConfirmationURL }}` is automatically generated by Supabase using your Site URL.

### 3. Email Sender (Future)
**Path:** Authentication ‚Üí Email Settings

Currently using Supabase default sender. For production:
1. Verify domain ownership: `avocat-dz.online`
2. Configure custom SMTP or provider (SendGrid/AWS SES)
3. Update sender to: `no-reply@avocat-dz.online`

**Status:** ‚è≥ Pending (can launch with Supabase default)

---

## üöÄ Deployment Checklist

### Pre-Deployment
- [x] Code changes committed
- [x] Environment variables documented
- [x] `.env.example` created
- [x] No hardcoded URLs remaining
- [ ] Update `.env.local` for production deployment

### Supabase Configuration
- [ ] Update Site URL to `https://avocat-dz.online`
- [ ] Add redirect URLs (see table above)
- [ ] Update email templates with production domain
- [ ] Test email confirmation flow in staging

### Domain & Hosting
- [ ] Domain `avocat-dz.online` DNS configured
- [ ] SSL certificate active (HTTPS)
- [ ] Deploy to hosting platform (Vercel recommended)
- [ ] Set `NEXT_PUBLIC_SITE_URL=https://avocat-dz.online` in hosting env

### Post-Deployment Testing
- [ ] Register new account ‚Üí verify email arrives
- [ ] Click email confirmation link ‚Üí redirects to correct URL
- [ ] Scan lawyer QR code ‚Üí loads `https://avocat-dz.online/lawyer/[id]`
- [ ] Share Legal Insight ‚Üí URL shows production domain
- [ ] Test returnUrl flow: QR scan ‚Üí login ‚Üí redirect to profile
- [ ] Check OpenGraph tags (Facebook/Twitter link preview)

---

## üîç Verification Steps

### 1. Test QR Code URLs
```bash
# Expected output when scanning QR code:
https://avocat-dz.online/lawyer/[lawyer-id]
```

### 2. Test Share URLs
```bash
# Expected output when sharing legal insight:
https://avocat-dz.online/insights/[insight-id]
```

### 3. Test Auth Flow
1. Register new account at: `https://avocat-dz.online/auth/register`
2. Check email inbox for confirmation
3. Confirmation link should be: `https://avocat-dz.online/...`
4. After confirmation, should redirect correctly

### 4. Test Metadata
```bash
# View page source and verify:
<meta property="og:url" content="https://avocat-dz.online" />
<meta property="og:site_name" content="Avoca" />
<link rel="canonical" href="https://avocat-dz.online/..." />
```

---

## üìã Files Modified

| File | Purpose | Status |
|------|---------|--------|
| `lib/config.ts` | Centralized URL configuration | ‚úÖ Created |
| `app/lawyer/[id]/page.tsx` | Public profile QR codes | ‚úÖ Updated |
| `app/lawyer/profile/edit/page.tsx` | Edit profile QR codes | ‚úÖ Updated |
| `lib/share-utils.ts` | Legal Insights sharing | ‚úÖ Updated |
| `app/auth/register/page.tsx` | Auth email redirects | ‚úÖ Updated |
| `app/layout.tsx` | SEO metadata & OpenGraph | ‚úÖ Updated |
| `.env.example` | Environment variables documentation | ‚úÖ Created |
| `DOMAIN_INTEGRATION_GUIDE.md` | This guide | ‚úÖ Created |

---

## üõ°Ô∏è Security Notes

### Environment Variables
- ‚úÖ `NEXT_PUBLIC_SITE_URL` is safe (public)
- ‚ö†Ô∏è `SUPABASE_SERVICE_ROLE_KEY` must be secret (server-only)
- ‚ö†Ô∏è Never commit `.env.local` to git
- ‚úÖ Use `.gitignore` to exclude env files

### Supabase Redirect Validation
- ‚úÖ Whitelist prevents unauthorized redirects
- ‚úÖ Only allows paths under `avocat-dz.online`
- ‚úÖ Blocks phishing/redirect attacks

### HTTPS Enforcement
- ‚ö†Ô∏è Production MUST use HTTPS
- ‚ö†Ô∏è Geolocation API requires secure context
- ‚ö†Ô∏è QR code scanning works better with HTTPS

---

## üêõ Troubleshooting

### Issue: Email links point to localhost
**Cause:** `NEXT_PUBLIC_SITE_URL` not set in production
**Fix:** Set environment variable in hosting platform

### Issue: Redirect after login fails
**Cause:** URL not whitelisted in Supabase
**Fix:** Add URL to Supabase redirect URLs (see section above)

### Issue: QR codes show wrong domain
**Cause:** Environment variable not picked up
**Fix:** 
1. Verify `NEXT_PUBLIC_SITE_URL` is set
2. Restart dev server
3. Clear Next.js cache: `rm -rf .next`

### Issue: Social media preview broken
**Cause:** `metadataBase` not set correctly
**Fix:** Verify `app/layout.tsx` has proper metadata configuration

---

## üìß Email Branding

All system emails should mention:
- **From:** `no-reply@avocat-dz.online` (when custom SMTP configured)
- **Signature:** "Avoca ‚Äì Legal Services in Algeria"
- **Footer:** `https://avocat-dz.online`

---

## ‚úÖ Success Criteria

The integration is complete when:
- [x] No hardcoded `localhost` or `window.location.origin` in code
- [x] All URLs use centralized `lib/config.ts`
- [x] QR codes generate with production domain
- [x] Share links use production domain
- [ ] Auth emails redirect to production domain
- [ ] Supabase dashboard configured
- [x] Metadata/SEO includes production domain
- [x] Environment variables documented

---

## üöÄ Next Steps

1. **Deploy to production:**
   - Build: `npm run build`
   - Deploy to Vercel/hosting platform
   - Set `NEXT_PUBLIC_SITE_URL=https://avocat-dz.online`

2. **Update Supabase:**
   - Follow checklist in "Supabase Dashboard Configuration"
   - Test email flow after update

3. **Verify everything works:**
   - Follow "Post-Deployment Testing" checklist
   - Monitor for any redirect issues

4. **Optional enhancements:**
   - Set up custom SMTP for `no-reply@avocat-dz.online`
   - Configure domain email forwarding
   - Set up monitoring/analytics

---

**Status:** ‚úÖ Code Integration Complete  
**Remaining:** Supabase Dashboard Configuration  
**Deployment:** Ready for production

**Last Updated:** January 5, 2026  
**Domain:** https://avocat-dz.online
